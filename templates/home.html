{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DEBUG: DOMContentLoaded ejecutado en home.html'); // Log para depurar

    const token = localStorage.getItem('access_token');
    console.log('DEBUG: Token obtenido de localStorage:', token); // Log para depurar

    if (!token) {
        console.log('DEBUG: No hay token en localStorage, redirigiendo a login.'); // Log para depurar
        window.location.href = '/auth/login';
        return;
    }

    console.log('DEBUG: Token encontrado, intentando verificar sesión.'); // Log para depurar

    // Llamar a la API para verificar la sesión y obtener el rol
    fetch('/auth/api/verify-session', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}` // Enviar token
        }
    })
    .then(response => {
        console.log('DEBUG: Respuesta de la API recibida, status:', response.status); // Log para depurar
        console.log('DEBUG: Headers de respuesta:', response.headers); // Log para depurar

        if (!response.ok) {
            console.error('DEBUG: La API respondió con error, status:', response.status); // Log para depurar
            // Si no está autorizado, redirigir al login
            throw new Error('Unauthorized');
        }

        console.log('DEBUG: La API respondió con éxito, intentando leer JSON...'); // Log para depurar
        return response.json();
    })
    .then(data => {
        console.log('DEBUG: Datos recibidos de la API:', data); // Log para depurar
        console.log('DEBUG: Tipo de data:', typeof data); // Log para depurar
        console.log('DEBUG: Propiedades de data:', Object.keys(data)); // Log para depurar

        if (!data || typeof data !== 'object') {
            console.error('DEBUG: La respuesta de la API no es un objeto válido:', data); // Log para depurar
            throw new Error('Invalid response format');
        }

        const userRole = data.role;
        console.log('DEBUG: Rol del usuario extraído:', userRole); // Log para depurar

        if (!userRole) {
            console.error('DEBUG: La respuesta de la API no contiene un rol válido:', data); // Log para depurar
            window.location.href = '/auth/login';
            return;
        }

        // Mapear roles a URLs de dashboard
        const roleToDashboard = {
            'superadmin': '/auth/dashboard/superadmin',
            'director': '/auth/dashboard/director', // Asegúrate de que esta ruta exista
            'administrativo': '/auth/dashboard/administrativo', // Asegúrate de que esta ruta exista
            'profesor': '/auth/dashboard/profesor', // Asegúrate de que esta ruta exista
            'alumno': '/auth/dashboard/alumno' // Asegúrate de que esta ruta exista
        };

        // Obtener la URL según el rol, o redirigir a login si no se encuentra
        const redirectUrl = roleToDashboard[userRole];

        if (redirectUrl) {
            console.log('DEBUG: Redirigiendo a:', redirectUrl); // Log para depurar
            window.location.href = redirectUrl;
        } else {
            console.log('DEBUG: Rol no reconocido en el mapeo, redirigiendo a login. Rol recibido:', userRole); // Log para depurar
            window.location.href = '/auth/login';
        }
    })
    .catch(error => {
        console.error('DEBUG: Error AL COMPLETO en la promesa fetch:', error); // Log para depurar
        console.error('DEBUG: Mensaje del error:', error.message); // Log para depurar
        console.error('DEBUG: Stack del error:', error.stack); // Log para depurar
        // Redirigir a login si hay error
        window.location.href = '/auth/login';
    });
});
</script>
{% endblock %}